# Grouped Relative Policy Optimization (GRPO)
# >>> ./.meta/mast/launch.sh .meta/mast/qwen3_14b_mast.yaml

# Global configuration
group_size: 8
local_batch_size: 16 # per-device batch size
max_req_tokens: 512
max_res_tokens: 512
model: "Qwen/Qwen3-14B"
off_by_n: 1 # Off by one by default
launcher: mast
job_name: forge-qwen3-14b

# Main loop configuration
rollout_threads: ${services.policy.num_replicas}   # Recommended to set equal to policy.num_replicas

# Observability configuration
metric_logging:
  wandb:
    project: "grpo-training"
    group: "grpo_exp_${oc.env:USER}"
    logging_mode: global_reduce
  console:
    logging_mode: global_reduce

# Dataset configuration
dataset:
  path: /mnt/wsfuse/teamforge/hf/gsm8k
  revision: "main"
  data_split: "train"
  streaming: true
  model: ${model}

# Policy configuration
policy:
  engine_args:  # https://docs.vllm.ai/en/v0.10.0/api/vllm/engine/arg_utils.html#vllm.engine.arg_utils.EngineArgs
    model: /mnt/wsfuse/teamforge/hf/qwen3_14b
    tensor_parallel_size: 2
    pipeline_parallel_size: 1
    enforce_eager: false
    # TODO: Had to disable this becasue vLLm wouldn't like
    # needs to revisited.
    disable_custom_all_reduce: true
  sampling_params:  # https://docs.vllm.ai/en/v0.10.0/api/vllm/sampling_params.html#vllm.sampling_params.SamplingParams
    n: ${group_size}
    max_tokens: ${max_res_tokens}
    temperature: 1.0
    top_p: 1.0

# Trainer configuration
trainer:
  model:
    name: qwen3
    flavor: 14B
    hf_assets_path: /mnt/wsfuse/teamforge/hf/qwen3_14b
  optimizer:
    name: AdamW
    lr: 1e-5
    eps: 1e-8
  lr_scheduler:
    warmup_steps: 1
  training:
    local_batch_size: ${local_batch_size}
    seq_len: ${sum:${max_req_tokens},${max_res_tokens}}  # seq_len >= max_req_tokens + max_res_tokens
    max_norm: 1.0
    steps: 1000000
    dtype: bfloat16
    gc_freq: 1
  compile:
    enable: false
  parallelism:
    data_parallel_replicate_degree: 1
    data_parallel_shard_degree: 8
    tensor_parallel_degree: 1
    pipeline_parallel_degree: 1
    context_parallel_degree: 1
    expert_parallel_degree: 1
    disable_loss_parallel: true
  checkpoint:
    enable: true
    initial_load_path: /mnt/wsfuse/teamforge/hf/qwen3_14b
    initial_load_in_hf: true
    folder: ${checkpoint_folder}
    last_save_in_hf: true
    interval: 500
    async_mode: "disabled"
  activation_checkpoint:
    mode: full
    selective_ac_option: op
  comm:
    # TODO: needs to be revisited. causing NCCL timeouts on inits when loading CP
    # from oilfs if the traienr is not in the same region as in oilfs
    init_timeout_seconds: 1200
  dcp_path: ${checkpoint_folder}

# Replay buffer configuration
replay_buffer:
  batch_size: ${local_batch_size}
  max_policy_age: ${off_by_n}
  dp_size: ${trainer.parallelism.data_parallel_shard_degree} # Must equal trainer DP degree

# Reference model configuration
ref_model:
  model:
    name: qwen3
    flavor: 14B
    hf_assets_path: /mnt/wsfuse/teamforge/hf/qwen3_14b
  training:
    seq_len: ${trainer.training.seq_len}
    dtype: bfloat16
    gc_freq: 1
  compile:
    enable: false
  parallelism:
    data_parallel_replicate_degree: 1
    data_parallel_shard_degree: 2
    tensor_parallel_degree: 1
    pipeline_parallel_degree: 1
    context_parallel_degree: 1
    expert_parallel_degree: 1
  checkpoint:
    enable: true
    initial_load_path: /mnt/wsfuse/teamforge/hf/qwen3_14b
    folder: ""
    initial_load_in_hf: true
  comm:
    # TODO: needs to be revisited. causing NCCL timeouts on inits when loading CP
    # from oilfs if the traienr is not in the same region as in oilfs
    init_timeout_seconds: 1200

# All resource allocations
services:
  policy:
    procs: ${policy.engine_args.tensor_parallel_size}
    num_replicas: 2
    with_gpus: true
    mesh_name: policy
    hosts: 1
  ref_model:
    procs: 2
    num_replicas: 2
    with_gpus: true
    mesh_name: ref_model
    hosts: 1
  reward_actor:
    procs: 1
    num_replicas: 1
    with_gpus: false
    mesh_name: reward_actor

actors:
  dataset:
    procs: 1
    with_gpus: false
    mesh_name: dataset
  trainer:
    procs: 8
    with_gpus: true
    mesh_name: trainer
    hosts: 1
  replay_buffer:
    procs: 1
    with_gpus: false
    mesh_name: replay_buffer
  compute_advantages:
    procs: 1
    with_gpus: false
    mesh_name: compute_advantages
